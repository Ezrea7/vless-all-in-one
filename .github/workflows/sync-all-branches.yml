name: Sync All Branches - vless-all-in-one

on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check and sync
        run: |
          # âœ… ä¿®å¤ï¼šå…ˆæ·»åŠ  remoteï¼Œå† fetch
          git remote add upstream https://github.com/Chil30/vless-all-in-one.git 2>/dev/null || true
          
          # âœ… ä¿®å¤ï¼šä½¿ç”¨ fetch upstream è€Œä¸æ˜¯ fetch upstream --all
          git fetch upstream --prune --tags
          
          HAS_UPDATE=false
          
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          for branch in $(git branch -r | grep '^  upstream/' | sed 's|^ *upstream/||'); do
            if git show-ref --quiet refs/heads/"$branch"; then
              LOCAL_HASH=$(git rev-parse refs/heads/"$branch")
              REMOTE_HASH=$(git rev-parse refs/remotes/upstream/"$branch")
              if [ "$LOCAL_HASH" != "$REMOTE_HASH" ]; then
                echo "âœ… [$branch] æœ‰æ›´æ–°"
                HAS_UPDATE=true
              else
                echo "â­ï¸  [$branch] æ— æ›´æ–°"
              fi
            else
              echo "âœ¨ [$branch] æ˜¯æ–°åˆ†æ”¯"
              HAS_UPDATE=true
            fi
          done
          
          if [ "$HAS_UPDATE" = false ]; then
            echo ""
            echo "âœ… æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi
          
          # æœ‰æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥
          echo ""
          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          echo ""
          
          for branch in $(git branch -r | grep '^  upstream/' | sed 's|^ *upstream/||'); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¤ åŒæ­¥åˆ†æ”¯: $branch"
            
            git checkout "$branch" 2>/dev/null || git checkout -b "$branch" "upstream/$branch"
            
            if git merge upstream/"$branch" -m "ğŸ”„ sync: merge upstream/$branch ($(date -u '+%Y-%m-%d'))"; then
              echo "âœ… [$branch] åˆå¹¶æˆåŠŸ"
            else
              echo "âš ï¸  [$branch] åˆå¹¶å†²çªï¼Œä¸­æ­¢"
              git merge --abort
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¤ æ¨é€æ‰€æœ‰åˆ†æ”¯..."
          
          git push origin --all --force-with-lease 2>/dev/null || git push origin --all --force
          
          echo "ğŸ·ï¸  æ¨é€æ ‡ç­¾..."
          git push origin --tags 2>/dev/null || true
          
          echo ""
          echo "âœ… åŒæ­¥å®Œæˆ"