name: Sync All Branches - vless-all-in-one

on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Check and sync
        run: |
          git remote add upstream https://github.com/Chil30/vless-all-in-one.git 2>/dev/null || true
          git fetch upstream --all --prune --tags
          
          HAS_UPDATE=false
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          for branch in $(git branch -r | grep '^  upstream/' | sed 's|^ *upstream/||'); do
            if git show-ref --quiet refs/heads/"$branch"; then
              if [ "$(git rev-parse refs/heads/$branch)" != "$(git rev-parse refs/remotes/upstream/$branch)" ]; then
                HAS_UPDATE=true
                break
              fi
            else
              HAS_UPDATE=true
              break
            fi
          done
          
          if [ "$HAS_UPDATE" = false ]; then
            echo "âœ… æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi
          
          # æœ‰æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥
          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          for branch in $(git branch -r | grep '^  upstream/' | sed 's|^ *upstream/||'); do
            git checkout "$branch" 2>/dev/null || git checkout -b "$branch" "upstream/$branch"
            git merge upstream/"$branch" -m "ğŸ”„ sync: $(date -u '+%Y-%m-%d')" || true
          done
          
          git push origin --all --force-with-lease || git push origin --all --force
          git push origin --tags || true
          
          echo "âœ… åŒæ­¥å®Œæˆ"